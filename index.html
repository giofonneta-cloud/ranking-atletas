<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ranking en vivo</title>
  <!-- Tailwind CSS for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase client library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-10 bg-slate-950/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="font-black text-xl">üèÅ Ranking en vivo</div>
      <div class="ml-auto flex items-center gap-2">
        <select id="eventFilter" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm">
          <option value="">Todas las pruebas</option>
        </select>
        <button id="refreshBtn" class="bg-slate-100 text-slate-900 rounded-xl px-3 py-2 text-sm font-semibold">
          Refrescar
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid gap-4 md:grid-cols-3">
      <!-- Tabla de posiciones -->
      <div class="md:col-span-2 bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
        <div class="flex items-center gap-2">
          <div class="text-lg font-bold">Tabla de posiciones</div>
          <div id="liveDot" class="ml-auto flex items-center gap-2 text-xs text-slate-300">
            <span class="inline-block w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            LIVE
          </div>
        </div>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead class="text-slate-300">
              <tr class="[&>th]:py-2 [&>th]:px-3 text-left border-b border-slate-800">
                <th>#</th>
                <th>Atleta</th>
                <th>Documento</th>
                <th>Categor√≠a</th>
                <th>Sexo</th>
                <th>Prueba</th>
                <th>Tiempo</th>
                <th>Registrado</th>
              </tr>
            </thead>
            <tbody id="rankBody" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
        <div id="emptyState" class="hidden mt-6 text-slate-300 text-sm">
          No hay resultados todav√≠a.
        </div>
      </div>

      <!-- Accesos r√°pidos -->
      <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
        <div class="text-lg font-bold">Accesos r√°pidos</div>
        <div class="mt-3 grid gap-2">
          <a class="block bg-slate-100 text-slate-900 rounded-xl px-4 py-3 font-semibold" href="./athletes.html">‚ûï Registrar atletas</a>
          <a class="block bg-slate-100 text-slate-900 rounded-xl px-4 py-3 font-semibold" href="./results.html">‚è±Ô∏è Registrar tiempos</a>
        </div>
        <div class="mt-6 p-3 rounded-xl bg-slate-950 border border-slate-800 text-xs text-slate-300">
          Se actualiza autom√°ticamente cuando alguien registra tiempos desde m√≥vil.
        </div>
      </div>
    </div>
  </main>

<script>
  // Configuraci√≥n de Supabase
  const SUPABASE_URL = "https://djoaknkhbtvbovcivi.supabase.co";
  // Clave an√≥nima: reemplaza con tu propia clave de publicaci√≥n de Supabase
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const rankBody = document.getElementById("rankBody");
  const emptyState = document.getElementById("emptyState");
  const eventFilter = document.getElementById("eventFilter");

  // Formatea la fecha/hora en formato local
  function fmtDate(iso) {
    const d = new Date(iso);
    return d.toLocaleString("es-CO", { hour12: false });
  }

  // Carga las opciones de prueba (eventos) desde la tabla results
  async function loadEventOptions() {
    const { data, error } = await supabase
      .from("results")
      .select("event_test")
      .order("event_test", { ascending: true });
    if (error) return;
    const unique = [...new Set((data || []).map(r => r.event_test))].filter(Boolean);
    const current = eventFilter.value;
    // Limpia opciones existentes (deja s√≥lo la primera)
    while (eventFilter.options.length > 1) eventFilter.remove(1);
    unique.forEach(ev => {
      const opt = document.createElement("option");
      opt.value = ev;
      opt.textContent = ev;
      eventFilter.appendChild(opt);
    });
    eventFilter.value = current;
  }

  // Carga y ordena los resultados para mostrar el ranking
  async function loadRanking() {
    const ev = eventFilter.value;
    let q = supabase
      .from("results")
      .select("id, athlete_id, event_test, time_ms, time_text, created_at, athletes(full_name, document_number, category, sex)")
      .order("time_ms", { ascending: true });
    if (ev) q = q.eq("event_test", ev);
    const { data, error } = await q;
    if (error) {
      console.error(error);
      return;
    }
    // Encontrar el mejor tiempo por atleta y prueba
    const bestMap = new Map();
    (data || []).forEach(r => {
      const key = `${r.athlete_id}__${r.event_test}`;
      const prev = bestMap.get(key);
      if (!prev || r.time_ms < prev.time_ms) bestMap.set(key, r);
    });
    const rows = Array.from(bestMap.values()).sort((a,b) => a.time_ms - b.time_ms);
    rankBody.innerHTML = "";
    if (!rows.length) {
      emptyState.classList.remove("hidden");
      return;
    }
    emptyState.classList.add("hidden");
    rows.forEach((r, idx) => {
      const a = r.athletes || {};
      const tr = document.createElement("tr");
      tr.className = "[&>td]:py-2 [&>td]:px-3";
      tr.innerHTML = `
        <td class="font-bold">${idx + 1}</td>
        <td class="font-semibold">${a.full_name ?? "-"}</td>
        <td class="text-slate-300">${a.document_number ?? "-"}</td>
        <td>${a.category ?? "-"}</td>
        <td>${a.sex ?? "-"}</td>
        <td>${r.event_test}</td>
        <td class="font-black text-emerald-300">${r.time_text}</td>
        <td class="text-slate-300">${fmtDate(r.created_at)}</td>
      `;
      rankBody.appendChild(tr);
    });
  }

  // Inicializa la p√°gina
  async function boot() {
    await loadEventOptions();
    await loadRanking();
    // Suscripci√≥n en tiempo real a nuevos resultados
    supabase
      .channel("results-live")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "results" }, async () => {
        await loadEventOptions();
        await loadRanking();
      })
      .subscribe();
  }
  // Eventos de interfaz
  document.getElementById("refreshBtn").addEventListener("click", async () => {
    await loadEventOptions();
    await loadRanking();
  });
  eventFilter.addEventListener("change", loadRanking);
  // Ejecutar boot
  boot();
</script>
</body>
</html>
